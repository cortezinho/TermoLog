<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <title>TermoLog Pro - Multi-Sensor</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background-color: #f0f2f5; display: flex; flex-direction: column; align-items: center; padding: 20px; }
        .container { width: 100%; max-width: 1000px; background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .config { display: flex; gap: 10px; align-items: center; justify-content: center; margin-bottom: 20px; }
        .display { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        .card { background: #fff; border: 1px solid #ddd; flex: 1; padding: 15px; border-radius: 10px; text-align: center; }
        .card label { font-size: 11px; color: #888; text-transform: uppercase; }
        .card div { font-size: 24px; font-weight: bold; margin-top: 5px; }
        .chart-container { position: relative; height: 200px; width: 100%; margin-bottom: 15px; }
        button { padding: 10px 20px; cursor: pointer; border: none; border-radius: 5px; background: #2196f3; color: white; font-weight: bold; }
        button.stop { background: #f44336; }
        #status-text { font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align: center;">TermoLog Monitor</h1>
    
    <div class="config">
        <button id="btnScan" onclick="escanear()">ESCANEAR DISPOSITIVOS</button>
    </div>

    <div id="status" style="text-align:center; margin-bottom:10px;">
        <span id="status-text" style="color: gray;">Aguardando...</span><br>
        <input type="checkbox" id="checkPontos" onchange="renderizar()" checked> Exibir Pontos
    </div>

    <div class="display">
        <div class="card"><label>DHT11 Temp</label><div id="t1" style="color: #f44336;">--</div></div>
        <div class="card"><label>DHT11 Umid</label><div id="u1" style="color: #2196f3;">--</div></div>
        <div class="card"><label>DS18B20 Temp</label><div id="t2" style="color: #ff9800;">--</div></div>
    </div>

    <div class="chart-container"><canvas id="chartT1"></canvas></div>
    <div class="chart-container"><canvas id="chartU1"></canvas></div>
    <div class="chart-container"><canvas id="chartT2"></canvas></div>
</div>

<script>
    let ip = "termolog.local";
    let charts = {};
    let monitoring = false;

    function initChart(id, label, color) {
        return new Chart(document.getElementById(id).getContext('2d'), {
            type: 'line',
            data: { labels: [], datasets: [{ label: label, data: [], borderColor: color, fill: false, tension: 0.1, pointRadius: 3 }] },
            options: { responsive: true, maintainAspectRatio: false, animation: false }
        });
    }

    charts.t1 = initChart('chartT1', 'Temp DHT11 (째C)', '#f44336');
    charts.u1 = initChart('chartU1', 'Umid DHT11 (%)', '#2196f3');
    charts.t2 = initChart('chartT2', 'Temp DS18B20 (째C)', '#ff9800');

    function renderizar() {
        const r = document.getElementById('checkPontos').checked ? 3 : 0;
        Object.values(charts).forEach(c => { c.data.datasets[0].pointRadius = r; c.update(); });
    }

    async function fetchData() {
        const statusText = document.getElementById('status-text');
        try {
            const res = await fetch(`http://${ip}/data`);
            const data = await res.json();
            const hora = new Date().toLocaleTimeString();

            // Atualiza o texto para conectado
            statusText.innerText = "Conectado ao ESP32";
            statusText.style.color = "green";

            document.getElementById('t1').innerText = data.temp + "째C";
            document.getElementById('u1').innerText = data.umid + "%";
            document.getElementById('t2').innerText = data.temp_extra + "째C";

            updateChart(charts.t1, hora, data.temp);
            updateChart(charts.u1, hora, data.umid);
            updateChart(charts.t2, hora, data.temp_extra);
        } catch (e) { 
            statusText.innerText = "Erro ao conectar! Verifique a rede.";
            statusText.style.color = "red";
        }
    }

    function updateChart(c, h, v) { c.data.labels.push(h); c.data.datasets[0].data.push(v); c.update(); }

    function escanear() {
        const btn = document.getElementById('btnScan');
        const statusText = document.getElementById('status-text');
        
        monitoring = !monitoring;
        
        if(monitoring) {
            btn.innerText = "PARAR"; 
            btn.className = "stop";
            statusText.innerText = "Buscando dispositivo...";
            statusText.style.color = "orange";
            
            window.timer = setInterval(fetchData, 5000);
            fetchData();
        } else {
            btn.innerText = "ESCANEAR DISPOSITIVOS"; 
            btn.className = "";
            statusText.innerText = "Aguardando...";
            statusText.style.color = "gray";
            clearInterval(window.timer);
        }
    }
</script>
</body>
</html>